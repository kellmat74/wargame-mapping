# Tactical Map Generator - AI Assistant Guide

## Project Overview

A tactical hex-based wargame map generator that creates US Army military-style maps suitable for tabletop wargaming. The system generates print-ready SVG files (34" × 22") with 250m hexes from any location worldwide using OpenStreetMap and SRTM elevation data.

**Key capabilities:**
- Works anywhere in the world (auto-detects UTM zone and data sources)
- Web UI for configuration at http://localhost:8080
- Auto-downloads geographic data from OSM/SRTM
- Outputs SVG files for editing in Affinity Designer/Illustrator

## Architecture

### Core Files

| File | Purpose |
|------|---------|
| `tactical_map.py` | Main map generator (~4000 lines) - rendering pipeline, terrain classification, SVG output |
| `game_map_converter.py` | Converts detail maps to game-ready maps with elevation overlays and simplified labels |
| `hexgrid.py` | Hex grid geometry - axial coordinates, polygon generation |
| `map_server.py` | Flask web server for configuration UI |
| `map_config.html` | Web-based map configuration interface |
| `download_mgrs_data.py` | Downloads OSM/SRTM data for MGRS squares |
| `region_registry.py` | Auto-discovers available Geofabrik PBF files |
| `map_utils.py` | Utility classes (Bounds, RotationConfig, CoordinateTransformer) |
| `render_helpers.py` | SVG rendering helper functions |

### Configuration Files

| File | Purpose |
|------|---------|
| `map_defaults.json` | Shared settings (hex size, grid dimensions, contour intervals, print specs) |
| `map_config.json` | User-specified map config (location, rotation, name) - generated by web UI |

### Data Flow

```
Web UI (map_config.html)
    ↓
map_config.json
    ↓
region_registry.py → auto-detect Geofabrik region
    ↓
download_mgrs_data.py → download OSM/SRTM data
    ↓
tactical_map.py:
    1. Load config and data
    2. Setup coordinate transformer (WGS84 ↔ UTM)
    3. Generate hex grid
    4. Classify terrain from OSM landcover
    5. Generate contours from DEM
    6. Render SVG layers (bottom to top)
    ↓
output/{country}/{name}/{timestamp}_{version}/:
    - {name}_tactical.svg
    - {name}_hexdata.json
    - map_config.json
    - game_map/              # Created by game_map_converter.py
        - {name}_game.svg
        - {name}_game.png
        - {name}_game.pdf
```

### Game Map Conversion

The `game_map_converter.py` transforms detail maps into game-ready maps:
- Applies terrain color palette (temperate/arid)
- Adds elevation tinting (darker at higher elevations)
- Adds hillside shading (edge bands where elevation drops)
- Maroon border frame
- Simplified hex labels (rows 1, 5, 10, 15, 20, 25 only)

**Important (v1.1.0+):** Elevation overlays are now pre-generated during detail map creation in `tactical_map.py` with `visibility="hidden"`. The game converter just unhides them. This ensures overlays align correctly on rotated maps.

### Versioning

Output folders include version: `{timestamp}_{version}` (e.g., `2026-01-01_15-17_v1.1.0`)

Current version: **v1.1.0** - See `VERSION` constant in `tactical_map.py`

## Gathering Context from Previous Sessions

**Check git history first:**
```bash
git log --oneline -20           # Quick overview
git log -5                      # Detailed recent commits
git diff HEAD~3                 # Recent changes
```

Commit messages contain technical context, decisions made, and rationale.

## Session Notes for Claude

**Use temp files for bash research** - Write investigative scripts to temp files and run them via `python3 temp_investigate.py` instead of using heredocs or inline commands that may trigger permission prompts. Clean up temp files when done.

**Run tests automatically** - After any code modification, run the relevant tests without waiting to be asked. See Testing section below.

**Also check:**
- `LESSONS_LEARNED.md` - Technical implementation details
- `FUTURE_IMPROVEMENTS.md` - Known issues and planned work
- `CONTOUR_ROTATION_ISSUE.md` - Detailed investigation notes on rotation math

## Map Specifications

| Parameter | Value |
|-----------|-------|
| Hex Size | 250m (center to center, flat-top orientation) |
| Grid Size | 47 columns × 26 rows |
| Playable Area | ~17km × 6.5km |
| Print Size | 34" × 22" with 0.125" bleed |
| Contours | 20m interval, 100m index contours |
| MGRS Grid | 1km UTM grid overlay |

## Coordinate Systems

The project uses multiple coordinate systems:

| CRS | Usage |
|-----|-------|
| WGS84 (EPSG:4326) | User input, OSM data |
| Dynamic UTM | All distance calculations (auto-selected based on map center) |
| MGRS | Data organization, grid labels |

**Important:** UTM zone is calculated from map center longitude. Maps spanning multiple zones may have edge distortion.

## Hex Geometry (Flat-top)

```python
HEX_SIZE_M = 250  # flat edge to flat edge
size = HEX_SIZE_M / sqrt(3)  # center to vertex (~144.34m)
col_spacing = 1.5 * size     # horizontal between columns
row_spacing = HEX_SIZE_M     # vertical between rows
```

Coordinate system:
- **q**: Column (increases east)
- **r**: Row (increases south-southeast)
- **Origin**: Northwest corner of grid

## Terrain Types

| Terrain | Color | Source |
|---------|-------|--------|
| Water | Light blue | OSM natural=water, waterway |
| Urban | Grey | OSM landuse=residential/commercial/industrial |
| Forest | Light green | OSM landuse=forest, natural=wood |
| Farmland | Pale yellow | OSM landuse=farmland |
| Orchard | Light green | OSM landuse=orchard |
| Scrub | Tan | OSM natural=scrub |
| Wetland | Blue-green | OSM natural=wetland |
| Clear | Beige | Default/fallback |

## SVG Layer Structure (Z-order)

1. Background (dark grey base)
2. Terrain layers (water, forest, urban, etc.)
3. Buildings
4. Contours (regular, then index)
5. Roads
6. Streams/rivers
7. Out-of-play frame (masks outside playable area)
8. Hex grid (spines at vertices)
9. Hex markers (center circles)
10. Hex labels (XX.YY format)
11. MGRS grid lines
12. MGRS labels
13. Data block (map metadata)

## Data Sources

| Data | Source |
|------|--------|
| Roads, buildings, landcover | OpenStreetMap via Geofabrik PBF files |
| Elevation (DEM) | SRTM 30m via OpenTopography |
| Reference tiles | OpenTopoMap |
| Coastlines | OSM land polygons |

Data is organized by MGRS square: `data/{zone}/{square}/`

## Common Tasks

### Generate a map
1. Start server: `python map_server.py` (or use launcher scripts)
2. Open http://localhost:8080
3. Enter coordinates, name, optional rotation
4. Click Generate Map

### Add new terrain type
1. Edit `tactical_map.py` - find `TERRAIN_COLORS` dict and `classify_terrain()` function
2. Add OSM tag mapping in terrain classification logic
3. Add color to TERRAIN_COLORS

### Modify hex grid rendering
- Hex polygon generation: `hexgrid.py`
- Spine/vertex rendering: `render_helpers.py`
- Grid overlay: `tactical_map.py` in `render_hex_grid()`

### Debug coordinate issues
- Use `CoordinateTransformer` class in `map_utils.py`
- Check UTM zone calculation in `get_utm_epsg()`
- Rotation math is in `RotationConfig` class

## SVG Structure for Rotated Maps

For maps with rotation, the SVG structure is critical for correct alignment:

```
Master_Content
├── Rotated_Reference (transform="rotate(...)")
│   └── Reference_Tiles (hidden)
├── Rotated_Content (transform="rotate(...)")
│   ├── Terrain layers (water, forest, urban, etc.)
│   ├── Contours
│   ├── Game_Elevation_Overlay (hidden, revealed by game converter)
│   ├── Game_Hillside_Shading (hidden, revealed by game converter)
│   ├── Roads, buildings, etc.
│   └── MGRS_Grid
├── Out_Of_Play_Frame (unrotated - clips rotated content)
├── Hex_Grid (unrotated - stays axis-aligned)
├── Hex_Markers (unrotated)
├── Hex_Labels (unrotated)
└── MGRS_Labels (unrotated)
```

**Key insight:** Game overlays MUST be inside `Rotated_Content` to align with terrain. The hex grid stays unrotated so labels remain readable.

## Known Issues / Limitations

- SVG pattern fills don't render in Affinity Designer (solid fills used instead)
- No cancel button for running generation (must stop server)
- Progress doesn't persist after page refresh
- Large maps may need multiple MGRS square downloads
- Maps spanning UTM zones may have edge distortion

## Resolved Issues

- **v1.1.0:** Fixed overlay alignment on rotated maps. Overlays are now generated during detail map creation (inside `Rotated_Content`) rather than during game conversion.

## Testing

**IMPORTANT: Always run tests after modifying code.** Don't wait for the user to ask.

```bash
cd "/Users/mattkelley/git/Wargame Mapping" && source venv/bin/activate && pytest tests/ -v
```

Test coverage:
- `test_map_utils.py` - Bounds, coordinate transforms, layer management
- `test_render_helpers.py` - SVG rendering helpers
- `test_game_map_converter.py` - Rotation detection, coordinate transforms, overlay placement

**Run tests proactively after changes to:**
- `game_map_converter.py` - run `pytest tests/test_game_map_converter.py -v`
- `map_utils.py` - run `pytest tests/test_map_utils.py -v`
- `render_helpers.py` - run `pytest tests/test_render_helpers.py -v`
- Any code change - run full suite `pytest tests/ -v`

## Dependencies

Key libraries:
- `geopandas`, `shapely` - Vector geometry
- `rasterio` - DEM/raster processing
- `pyproj` - Coordinate transformations
- `svgwrite` - SVG generation
- `mgrs` - Military Grid Reference System
- `flask` - Web UI

Install: `pip install -r requirements.txt`

## File Locations

```
data/
├── geofabrik/           # Downloaded PBF files by region
├── {zone}/{square}/     # MGRS-organized data (e.g., 51P/TT/)
│   ├── elevation.tif
│   ├── roads.geojson
│   ├── buildings.geojson
│   └── bounds.json
└── land-polygons/       # OSM coastline data

output/
└── {region}/{name}/     # Generated maps
    ├── {name}.svg
    ├── {name}_hexdata.json
    └── reference_tiles/

cache/
└── regions.json         # Cached region registry
```
